{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>Control de Fichajes</h4>
            </div>
            <div class="card-body text-center">
                <h5>{{ current_user.name }}, {{ now.strftime('%d/%m/%Y') }}</h5>

                {% if estimated_end_date %}
                <p class="mt-2">
                    Seg√∫n tu horario{% if extra_days %} (incluyendo d√≠as extra planificados){% endif %},
                    <strong>terminar√°s las pr√°cticas el {{ estimated_end_date.strftime('%d/%m/%Y') }}</strong>.
                </p>
                {% else %}
                {% if total_hours_required > 0 %}
                <p class="mt-2 text-muted">
                    Configura tu horario para calcular la fecha estimada de fin de pr√°cticas.
                </p>
                {% endif %}
                {% endif %}

                {% if active_record %}
                <div class="alert alert-warning mt-3">
                    <h6>Sesi√≥n activa desde:</h6>
                    <!-- ‚úÖ local time -->
                    <h4>{{ active_record.entry_time|localdt('%H:%M') }}</h4>

                    <!-- Mostrar ubicaci√≥n y mapa -->
                    <div class="location-info">
                        <strong>Ubicaci√≥n:</strong> {{ active_record.location }}
                        <div id="activeRecordMap" style="height: 250px; border-radius: 10px;" class="mt-2"></div>
                    </div>

                    <div class="mt-3">
                        <form action="{{ url_for('clock_out') }}" method="POST" id="clockOutForm">
                            <input type="hidden" name="location" id="locationOut" value="C√≥rdoba Ecuestre">
                            <input type="hidden" name="latitude" id="latitudeOut" value="37.8766614">
                            <input type="hidden" name="longitude" id="longitudeOut" value="-4.7831533">
                            <button type="submit" class="btn btn-danger btn-lg">
                                <i class="fas fa-stop-circle"></i> Parar Fichaje
                            </button>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info mt-3">
                    <p>No hay sesi√≥n activa. Puedes iniciar un nuevo fichaje.</p>
                    <form action="{{ url_for('clock_in') }}" method="POST" id="clockInForm">
                        <input type="hidden" name="location" id="locationIn" value="C√≥rdoba Ecuestre">
                        <input type="hidden" name="latitude" id="latitudeIn" value="37.8766614">
                        <input type="hidden" name="longitude" id="longitudeIn" value="-4.7831533">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-play-circle"></i> Iniciar Fichaje
                        </button>
                    </form>

                    <!-- Mapa de ubicaci√≥n -->
                    <div class="mt-3">
                        <div id="previewMap" style="height: 250px; border-radius: 10px;"></div>
                        <small class="text-muted">Tu ubicaci√≥n actual</small>
                        <div id="locationStatus" class="mt-2">
                            <div class="alert alert-info">Detectando tu ubicaci√≥n...</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Registros de hoy -->
                <div class="mt-4">
                    <h6>Fichajes de hoy</h6>
                    {% if today_records %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Inicio</th>
                                    <th>Fin</th>
                                    <th>Duraci√≥n</th>
                                    <th>Ubicaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in today_records %}
                                <tr class="{{ 'table-warning' if not record.exit_time }}">
                                    <!-- ‚úÖ local time -->
                                    <td>{{ record.entry_time|localdt('%H:%M') }}</td>
                                    <td>
                                        {% if record.exit_time %}
                                        {{ record.exit_time|localdt('%H:%M') }}
                                        {% else %}
                                        <span class="badge bg-warning">En curso</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.exit_time %}
                                        {{ (record.exit_time - record.entry_time).total_seconds() | hm_seconds }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.latitude and record.longitude %}
                                        <button class="btn btn-sm btn-outline-primary view-map-btn"
                                            data-lat="{{ record.latitude }}" data-lng="{{ record.longitude }}"
                                            data-location="{{ record.location }}">
                                            <i class="fas fa-map-marker-alt"></i> Ver mapa
                                        </button>
                                        {% else %}
                                        <span title="{{ record.location }}">{{ record.location|truncate(20) }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-muted">Total hoy: <strong>{{ (today_hours * 3600) | hm_seconds }}</strong></p>
                    {% else %}
                    <p class="text-muted">No hay fichajes hoy</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Horas semana -->
        <div class="stat-card">
            <h6>Horas esta semana</h6>
            <h3>{{ (weekly_hours * 3600) | hm_seconds }} / {{ "%.0f"|format(weekly_required_hours) }}h</h3>
            {% if weekly_required_hours > 0 %}
            <div class="progress mt-2" style="height: 20px;">
                <div class="progress-bar {% if weekly_hours >= weekly_required_hours %}bg-success{% elif weekly_hours >= weekly_required_hours * 0.8 %}bg-warning{% else %}bg-danger{% endif %}"
                    role="progressbar"
                    style="width: {{ (weekly_hours / weekly_required_hours * 100)|round if weekly_required_hours > 0 else 0 }}%"
                    aria-valuenow="{{ weekly_hours }}" aria-valuemin="0" aria-valuemax="{{ weekly_required_hours }}">
                    {{ "%.0f"|format(weekly_hours / weekly_required_hours * 100) if weekly_required_hours > 0 else 0 }}%
                </div>
            </div>
            {% else %}
            <small class="text-muted">No hay horarios configurados</small>
            {% endif %}
            <i class="fas fa-chart-line fa-2x text-primary mt-2"></i>
        </div>

        <!-- Horas totales pr√°cticas -->
        <div class="stat-card mt-3">
            <h6>Horas totales (Pr√°cticas)</h6>
            <h3>{{ (total_hours_worked * 3600) | hm_seconds }} / {{ "%.0f"|format(total_hours_required) }}h</h3>
            <div class="progress mt-2" style="height: 20px;">
                <div class="progress-bar {% if total_hours_worked >= total_hours_required %}bg-success{% elif total_hours_worked >= total_hours_required * 0.8 %}bg-info{% else %}bg-primary{% endif %}"
                    role="progressbar"
                    style="width: {{ (total_hours_worked / total_hours_required * 100)|round if total_hours_required > 0 else 0 }}%"
                    aria-valuenow="{{ total_hours_worked }}" aria-valuemin="0"
                    aria-valuemax="{{ total_hours_required }}">
                    {{ "%.0f"|format(total_hours_worked / total_hours_required * 100) if total_hours_required > 0 else 0
                    }}%
                </div>
            </div>

            {% if hours_remaining <= 0 %} <small class="text-success mt-1 d-block">
                ¬°Has completado todas las horas de pr√°cticas! üéâ
                </small>
                {% else %}
                <small class="text-muted mt-1 d-block">
                    Quedan: {{ (hours_remaining * 3600) | hm_seconds }}
                </small>
                {% if estimated_end_date %}
                <small class="text-muted d-block">
                    Fin estimado: <strong>{{ estimated_end_date.strftime('%d/%m/%Y') }}</strong>
                    {% if extra_days %}
                    (con d√≠as extra)
                    {% endif %}
                </small>
                {% else %}
                <small class="text-muted d-block">
                    Configura tu horario para poder calcular la fecha de fin.
                </small>
                {% endif %}
                {% endif %}

                <i class="fas fa-graduation-cap fa-2x text-info mt-2"></i>
        </div>

        <!-- D√≠as extra planificados -->
        <div class="stat-card mt-3">
            <h6>D√≠as extra planificados</h6>

            <form action="{{ url_for('add_extra_day') }}" method="POST" class="row g-2">
                <div class="col-7">
                    <label class="form-label small mb-0">Fecha</label>
                    <input type="date" name="extra_date" class="form-control form-control-sm"
                        min="{{ now.strftime('%Y-%m-%d') }}" required>
                </div>
                <div class="col-5">
                    <label class="form-label small mb-0">Horas</label>
                    <input type="number" name="extra_hours" class="form-control form-control-sm" step="0.5" min="0.5"
                        max="12" value="4" required>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-sm btn-outline-primary w-100 mt-1">
                        <i class="fas fa-plus"></i> A√±adir d√≠a extra
                    </button>
                </div>
            </form>

            {% if extra_days %}
            <hr>
            <ul class="list-unstyled mb-0 small">
                {% for d in extra_days %}
                <li class="d-flex justify-content-between align-items-center mb-1">
                    <span>{{ d.date.strftime('%d/%m/%Y') }} ¬∑ {{ "%.1f"|format(d.hours_planned) }}h</span>
                    <a href="{{ url_for('delete_extra_day', id=d.id) }}" class="text-danger small" title="Quitar">
                        <i class="fas fa-times"></i>
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="small text-muted mb-0 mt-2">
                No tienes d√≠as extra marcados. Usa el formulario para a√±adir alguno
                (por ejemplo, un lunes suelto).
            </p>
            {% endif %}
        </div>

        <!-- Estado actual -->
        <div class="stat-card mt-3">
            <h6>Estado actual</h6>
            {% if active_record %}
            <span class="badge bg-success">De Pr√°cticas</span>
            <!-- ‚úÖ local time -->
            <p class="small mt-1">Desde: {{ active_record.entry_time|localdt('%H:%M') }}</p>
            {% else %}
            <span class="badge bg-secondary">Descansando</span>
            {% endif %}
        </div>

        <!-- Acciones r√°pidas -->
        <div class="stat-card mt-3">
            <h6>Acciones r√°pidas</h6>
            <div class="d-grid gap-2">
                <a href="{{ url_for('records') }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-list"></i> Ver todos los registros
                </a>
                <a href="{{ url_for('reports') }}" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-file-alt"></i> Generar informe
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver mapa de registros -->
<div class="modal fade" id="recordMapModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ubicaci√≥n del fichaje</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="modalLocationText" class="mb-3"></p>
                <div id="recordMap" style="height: 400px; border-radius: 10px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // (tu JS igual que antes; sin cambios de zona horaria porque todo lo pintamos en el servidor)
    const WORK_LAT = 37.8766614;
    const WORK_LNG = -4.7831533;
    const WORK_LOCATION = "C√≥rdoba Ecuestre";
    let previewMap, currentMarker;

    function initMap(lat, lng, location) {
        if (previewMap) previewMap.remove();
        previewMap = L.map('previewMap').setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(previewMap);
        currentMarker = L.marker([lat, lng]).addTo(previewMap).bindPopup(location).openPopup();
    }

    function initActiveRecordMap(lat, lng) {
        const map = L.map('activeRecordMap').setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        L.marker([lat, lng]).addTo(map).bindPopup('Ubicaci√≥n del fichaje').openPopup();
    }

    function showRecordMap(lat, lng, location) {
        document.getElementById('modalLocationText').textContent = location;
        const mapContainer = document.getElementById('recordMap');
        if (mapContainer._leaflet_id) {
            mapContainer._leaflet_id = null;
            mapContainer.innerHTML = '';
        }
        setTimeout(() => {
            const recordMap = L.map('recordMap').setView([lat, lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(recordMap);
            L.marker([lat, lng]).addTo(recordMap).bindPopup('Ubicaci√≥n registrada').openPopup();
        }, 100);
    }

    async function getAddressFromCoords(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`);
            if (!response.ok) throw new Error('Error en Nominatim');
            const data = await response.json();
            return data.display_name || `Coordenadas: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        } catch (error) {
            return `Coordenadas: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }
    }

    function getLocationByBrowser() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) return reject("Geolocalizaci√≥n no soportada");
            navigator.geolocation.getCurrentPosition(
                (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                (err) => reject(err?.message || "Error de geolocalizaci√≥n"),
                { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
            );
        });
    }

    async function detectLocation() {
        const statusElement = document.getElementById('locationStatus');
        try {
            if (statusElement) statusElement.innerHTML = '<div class="alert alert-info">Intentando geolocalizaci√≥n del navegador...</div>';
            const browserPosition = await getLocationByBrowser();
            const address = await getAddressFromCoords(browserPosition.lat, browserPosition.lng);
            initMap(browserPosition.lat, browserPosition.lng, address);
            if (statusElement) statusElement.innerHTML = `<div class="alert alert-success">Ubicaci√≥n detectada: ${address}</div>`;
            return { location: address, lat: browserPosition.lat, lng: browserPosition.lng };
        } catch (e) {
            if (statusElement) statusElement.innerHTML = `<div class="alert alert-warning">Usando ubicaci√≥n de Practicas</div>`;
            initMap(WORK_LAT, WORK_LNG, WORK_LOCATION);
            return { location: WORK_LOCATION, lat: WORK_LAT, lng: WORK_LNG };
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.view-map-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const lat = parseFloat(this.getAttribute('data-lat'));
                const lng = parseFloat(this.getAttribute('data-lng'));
                const location = this.getAttribute('data-location');
                showRecordMap(lat, lng, location);
                new bootstrap.Modal(document.getElementById('recordMapModal')).show();
            });
        });

        if (!{{ (active_record is not none) | tojson }}) {
        initMap(WORK_LAT, WORK_LNG, WORK_LOCATION);
        setTimeout(() => { detectLocation(); }, 500);
    }

    {% if active_record and active_record.latitude and active_record.longitude %}
    setTimeout(() => { initActiveRecordMap({{ active_record.latitude }}, {{ active_record.longitude }}); }, 300);
    {% endif %}
    });

    document.getElementById('clockInForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detectando ubicaci√≥n...';
        try {
            const loc = await detectLocation();
            document.getElementById('locationIn').value = loc.location;
            document.getElementById('latitudeIn').value = loc.lat;
            document.getElementById('longitudeIn').value = loc.lng;
            this.submit();
        } catch (e) { this.submit(); }
    });

    document.getElementById('clockOutForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detectando ubicaci√≥n...';
        try {
            const loc = await detectLocation();
            document.getElementById('locationOut').value = loc.location;
            document.getElementById('latitudeOut').value = loc.lat;
            document.getElementById('longitudeOut').value = loc.lng;
            this.submit();
        } catch (e) { this.submit(); }
    });
</script>
{% endblock %}