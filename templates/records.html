{% extends 'base.html' %}

{% block title %}Mis Registros{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Mis Registros</h4>
    <a href="{{ url_for('user_add_record') }}" class="btn btn-primary btn-sm">
        <i class="fas fa-plus"></i> Nuevo fichaje
    </a>
</div>

{% if records.items %}
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead>
        <tr>
            <th>Fecha</th>
            <th>Entrada</th>
            <th>Salida</th>
            <th>Duración</th>
            <th>Ubicación</th>
            <th style="width:150px">Acciones</th>
        </tr>
        </thead>
        <tbody>
        {% for record in records.items %}
        <tr class="{{ 'table-warning' if not record.exit_time }}">
            <td>{{ record.date.strftime('%d/%m/%Y') }}</td>
            <td>{{ record.entry_time|localdt('%H:%M') }}</td>
            <td>
                {% if record.exit_time %}
                {{ record.exit_time|localdt('%H:%M') }}
                {% else %}
                <span class="badge bg-warning">En curso</span>
                {% endif %}
            </td>
            <td>
                {% if record.exit_time %}
                {{ (record.exit_time - record.entry_time).total_seconds() | hm_seconds }}
                {% else %}
                -
                {% endif %}
            </td>
            <td>
                {% if record.latitude and record.longitude %}
                <button class="btn btn-sm btn-outline-primary view-map-btn"
                        data-bs-toggle="modal" data-bs-target="#recordMapModal"
                        data-lat="{{ record.latitude }}"
                        data-lng="{{ record.longitude }}"
                        data-location="{{ record.location or 'Ubicación' }}">
                    <i class="fas fa-map-marker-alt"></i> Ver mapa
                </button>
                {% else %}
                <span title="{{ record.location }}">{{ (record.location or '—')|truncate(30) }}</span>
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('user_edit_record', record_id=record.id) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-edit"></i>
                </a>
                <form action="{{ url_for('user_delete_record', record_id=record.id) }}" method="POST" class="d-inline" onsubmit="return confirm('¿Eliminar este fichaje?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
<nav aria-label="Paginación">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if not records.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('records', page=records.prev_num) if records.has_prev else '#' }}" tabindex="-1">Anterior</a>
        </li>
        {% for p in range(1, records.pages + 1) %}
        <li class="page-item {% if p == records.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('records', page=p) }}">{{ p }}</a>
        </li>
        {% endfor %}
        <li class="page-item {% if not records.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('records', page=records.next_num) if records.has_next else '#' }}">Siguiente</a>
        </li>
    </ul>
</nav>

{% else %}
<div class="alert alert-info">No hay registros.</div>
{% endif %}

<!-- Modal mapa -->
<div class="modal fade" id="recordMapModal" tabindex="-1" aria-labelledby="recordMapLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recordMapLabel">Ubicación del fichaje</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="modalLocationText" class="mb-3"></p>
                <div id="recordMap" style="height: 420px; border-radius: 10px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // (igual que lo tenías)
    let recordMapInstance = null;
    function setupRecordMap(lat, lng) {
        const container = document.getElementById('recordMap');
        if (recordMapInstance) { recordMapInstance.remove(); recordMapInstance = null; }
        container.innerHTML = '';
        recordMapInstance = L.map('recordMap').setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(recordMapInstance);
        L.marker([lat, lng]).addTo(recordMapInstance).bindPopup('Ubicación registrada').openPopup();
    }
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.view-map-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const lat = parseFloat(this.dataset.lat);
                const lng = parseFloat(this.dataset.lng);
                const location = this.dataset.location || '';
                document.getElementById('modalLocationText').textContent = location;
                const modalEl = document.getElementById('recordMapModal');
                modalEl.addEventListener('shown.bs.modal', () => setupRecordMap(lat, lng), { once: true });
            });
        });
    });
</script>
{% endblock %}
